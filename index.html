<!-- SPDX-License-Identifier: MPL-2.0 -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta
    http-equiv="Content-Security-Policy"
    content="trusted-types test-policy; require-trusted-types-for 'script';"
  />

  <link
    rel="stylesheet"
    href="./styles.css"
  >
</head>

<body>
  <div>
    <h1>Trusted Types Tests</h1>
    <p>
      This page tests a selected set of DOM APIs for
      <a
        href="https://developer.mozilla.org/en-US/docs/Web/API/Trusted_Types_API"
      >Trusted Types</a>
      coverage.

      For broader coverage, view the test suite of:
      <a
        href="./attributes.html"
      >HTML element attributes</a>.
    </p>
  </div>

  <hr>

  <div>
    <p>
      LEGEND:
      <span class="covered">covered</span>: trusted types do apply.
      <span class="not-covered">not covered</span>: trusted types does not apply.
    </p>
  </div>

  <noscript>
    <p>
      This page tests
      <a href="https://developer.mozilla.org/en-US/docs/Web/API/Trusted_Types_API">Trusted Types</a>,
      which requires JavaScript to be enabled.
      Please enable JavaScript to run the Trusted Types tests.
    </p>
  </noscript>

  <div id="no-trusted-types" hidden>
    This browser does not support Trusted Types. Trusted Types tests cannot be
    run. Please switch to a
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Trusted_Types_API#browser_compatibility">browser with
      Trusted Types support</a>.
  </div>

  <div id="covered"></div>
  <div id="caught"></div>
  <div id="uncovered"></div>
  <div id="shadow" hidden></div>

  <script src="./helpers.js"></script>
  <script type="module">
  function test(name, cb) {
    const providers = {
      // Attributes
      get attr() { return createTestAttribute("attr"); },
      get onclick() { return createTestAttribute("onclick"); },

      // Elements
      get el() { return createTestElement("el"); },
      get a() { return createTestElement("a"); },
      get area() { return createTestElement("area"); },
      get base() { return createTestElement("base"); },
      get button() { return createTestElement("button"); },
      get data() { return createTestElement("data"); },
      get embed() { return createTestElement("embed"); },
      get fieldset() { return createTestElement("fieldset"); },
      get form() { return createTestElement("form"); },
      get iframe() { return createTestElement("iframe"); },
      get img() { return createTestElement("img"); },
      get input() { return createTestElement("input"); },
      get li() { return createTestElement("li"); },
      get link() { return createTestElement("link"); },
      get map() { return createTestElement("map"); },
      get menu() { return createTestElement("menu"); },
      get meta() { return createTestElement("meta"); },
      get meter() { return createTestElement("meter"); },
      get object() { return createTestElement("object"); },
      get ol() { return createTestElement("ol"); },
      get option() { return createTestElement("option"); },
      get output() { return createTestElement("output"); },
      get param() { return createTestElement("param"); },
      get progress() { return createTestElement("progress"); },
      get script() { return createTestElement("script"); },
      get select() { return createTestElement("select"); },
      get source() { return createTestElement("source"); },
      get style() { return createTestElement("style"); },
      get textarea() { return createTestElement("textarea"); },
    };

    testAndReport(name, () => {
      const r = cb(providers);
      if (r instanceof Promise) r.catch(() => null);
    });
  }

  if (hasTrustedTypes()) {
    const policy = trustedTypes.createPolicy("test-policy", {
      createHTML: (input) => input,
      createScript: (input) => input,
      createScriptURL: (input) => input,
    });

    const placeholder = "placeholder";
    const trusted = policy.createHTML("trusted");
    const element = document.createElement("name");

    test("attr.value=.", ({ attr }) => attr.value=UNTRUSTED);
    test("attr[onclick].value=.", ({ onclick }) => onclick.value=UNTRUSTED);
    test("CSSStyleDeclaration.cssText=.", ({ el }) => el.style.cssText=UNTRUSTED);
    test("document.cookie=.", () => document.cookie=UNTRUSTED);
    test("document.createAttribute(.)", () => document.createAttribute(UNTRUSTED));
    test("document.createAttributeNS(., _)", () => document.createAttributeNS(UNTRUSTED, placeholder));
    test("document.createAttributeNS(_, .)", () => document.createAttributeNS(placeholder, UNTRUSTED));
    test("document.createElement(.)", () => document.createElement(UNTRUSTED));
    test("document.createElementNS(., _)", () => document.createElement(UNTRUSTED, placeholder));
    test("document.createElementNS(_, .)", () => document.createElement(placeholder, UNTRUSTED));
    test("document.domain=.", () => document.domain=UNTRUSTED);
    test("document.evaluate(., _, _, _, _)", () => document.evaluate(UNTRUSTED, document, null, XPathResult.ANY_TYPE, null));
    test("document.execCommand(., _, _)", () => document.execCommand(UNTRUSTED, false, null));
    test("document.execCommand(_, _, .)", () => document.execCommand("unlink", false, UNTRUSTED));
    // test("document.location=.", () => document.location=untrusted);
    test("document.title=.", () => document.title=UNTRUSTED);
    test("document.write(.)", () => document.write(UNTRUSTED));
    test("document.write(_, .)", () => document.write(trusted, UNTRUSTED));
    test("document.writeln(.)", () => document.writeln(UNTRUSTED));
    test("document.writeln(_, .)", () => document.writeln(trusted, UNTRUSTED));
    test("DOMImplementation.createHTMLDocument(.)", () => document.implementation.createHTMLDocument(UNTRUSTED));
    test("DOMParser().parseFromString(., _)", () => (new DOMParser()).parseFromString(UNTRUSTED, trusted));
    test("DOMParser().parseFromString(_, .)", () => (new DOMParser()).parseFromString(trusted, "text/html"));
    test("Element.after(., ...)", ({ el }) => el.after(UNTRUSTED));
    test("Element.after(_, ., ...)", ({ el }) => el.after(trusted, UNTRUSTED));
    test("Element.append(., ...)", ({ el }) => el.append(UNTRUSTED));
    test("Element.append(_, ., ...)", ({ el }) => el.append(trusted, UNTRUSTED));
    test("Element.before(., ...)", ({ el }) => el.before(UNTRUSTED));
    test("Element.before(_, ., ...)", ({ el }) => el.before(trusted, UNTRUSTED));
    test("Element.innerHTML=.", ({ el }) => el.innerHTML=UNTRUSTED);
    test("Element.insertAdjacentElement(., _)", ({ el }) => el.insertAdjacentElement("afterbegin", element));
    test("Element.insertAdjacentElement(_, .)", ({ el }) => el.insertAdjacentElement("afterbegin", UNTRUSTED));
    test("Element.insertAdjacentHTML(., _)", ({ el }) => el.insertAdjacentHTML("afterbegin", trusted));
    test("Element.insertAdjacentHTML(_, .)", ({ el }) => el.insertAdjacentHTML("afterbegin", UNTRUSTED));
    test("Element.insertAdjacentText(., _)", ({ el }) => el.insertAdjacentText("afterbegin", trusted));
    test("Element.insertAdjacentText(_, .)", ({ el }) => el.insertAdjacentText("afterbegin", UNTRUSTED));
    test("Element.onclick=.", ({ el }) => el.onclick=UNTRUSTED);
    test("Element.outerHTML=.", ({ el }) => el.outerHTML=UNTRUSTED);
    test("Element.setAttribute(., _)", ({ el }) => el.setAttribute(UNTRUSTED, trusted));
    test("Element.setAttribute(_, .)", ({ el }) => el.setAttribute(trusted, UNTRUSTED));
    test("Element.setAttribute('onclick', .)", ({ el }) => el.setAttribute("onclick", UNTRUSTED));
    test("Element.setAttributeNS(., _, _)", ({ el }) => el.setAttributeNS(UNTRUSTED, trusted, trusted));
    test("Element.setAttributeNS(_, ., _)", ({ el }) => el.setAttributeNS(trusted, UNTRUSTED, trusted));
    test("Element.setAttributeNS(_, _, .)", ({ el }) => el.setAttributeNS(trusted, trusted, UNTRUSTED));
    test("Element.setAttributeNS('', 'onclick', .)", ({ el }) => el.setAttributeNS("", "onclick", UNTRUSTED));
    test("Element.setHTMLUnsafe(., _)", ({ el }) => el.setHTMLUnsafe(UNTRUSTED));
    test("eval(.)", () => eval(UNTRUSTED));
    test("new EventSource(., _)", () => new EventSource(UNTRUSTED));
    test("fetch(., _)", () => fetch(UNTRUSTED));
    test("new Function(.)", () => new Function(UNTRUSTED));
    test("new FileReader().readAsArrayBuffer()", () => (new FileReader()).readAsArrayBuffer(UNTRUSTED));
    test("new FileReader().readAsBinaryString()", () => (new FileReader()).readAsBinaryString(UNTRUSTED));
    test("new FileReader().readAsDataURL()", () => (new FileReader()).readAsDataURL(UNTRUSTED));
    test("new FileReader().readAsText()", () => (new FileReader()).readAsText(UNTRUSTED));
    test("history.pushState(., _, _)", () => history.pushState(UNTRUSTED, ""));
    test("history.pushState(_, ., _)", () => history.pushState(placeholder, UNTRUSTED));
    // test("history.pushState(_, _, .)", () => history.pushState(placeholder, untrusted, `${location}/untrusted`));
    test("history.replaceState(., _, _)", () => history.replaceState(UNTRUSTED, ""));
    test("history.replaceState(_, ., _)", () => history.replaceState(placeholder, UNTRUSTED));
    // test("history.replaceState(_, _, .)", () => history.replaceState(placeholder, untrusted, `${location}/untrusted`));
    test("HTMLElement.innerText=.", ({ el }) => el.innerText=UNTRUSTED);
    test("HTMLElement.outerText=.", ({ el }) => el.outerText=UNTRUSTED);
    test("HTMLElement.style=.", ({ el }) => el.style=UNTRUSTED);
    test("HTMLElement.style.cssText=.", ({ el }) => el.style.cssText=UNTRUSTED);
    test("HTMLAnchorElement.href=.", ({ a }) => a.href=UNTRUSTED);
    test("HTMLAnchorElement.target=.", ({ a }) => a.target=UNTRUSTED);
    test("HTMLAreaElement.target=.", ({ area }) => area.target=UNTRUSTED);
    test("HTMLBaseElement.target=.", ({ base }) => base.target=UNTRUSTED);
    test("HTMLButtonElement.name=.", ({ button }) => button.name =UNTRUSTED);
    test("HTMLButtonElement.type=.", ({ button }) => button.type=UNTRUSTED);
    test("HTMLButtonElement.value=.", ({ button }) => button.value=UNTRUSTED);
    test("HTMLDataElement.value=.", ({ data }) => data.value=UNTRUSTED);
    test("HTMLEmbedElement.src=.", ({ embed }) => embed.src=UNTRUSTED);
    test("HTMLEmbedElement.type=.", ({ embed }) => embed.type=UNTRUSTED);
    test("HTMLFormElement.action=.", ({ form }) => form.action=UNTRUSTED);
    test("HTMLFormElement.method=.", ({ form }) => form.method=UNTRUSTED);
    test("HTMLFormElement.name=.", ({ form }) => form.name=UNTRUSTED);
    test("HTMLFormElement.target=.", ({ form }) => form.target=UNTRUSTED);
    test("HTMLFieldsetElement.name=.", ({ fieldset }) => fieldset.name=UNTRUSTED);
    test("HTMLIFrameElement.name=.", ({ iframe }) => iframe.name=UNTRUSTED);
    test("HTMLIFrameElement.src=.", ({ iframe }) => iframe.src=UNTRUSTED);
    test("HTMLIFrameElement.srcdoc=.", ({ iframe }) => iframe.srcdoc=UNTRUSTED);
    test("HTMLImageElement.src=.", ({ img }) => img.src=UNTRUSTED);
    test("HTMLImageElement.srcset=.", ({ img }) => img.srcset=UNTRUSTED);
    test("HTMLInputElement.name=.", ({ input }) => input.name=UNTRUSTED);
    test("HTMLInputElement.type=.", ({ input }) => input.type=UNTRUSTED);
    test("HTMLInputElement.value=.", ({ input }) => input.value=UNTRUSTED);
    test("HTMLLinkElement.type=.", ({ link }) => link.type=UNTRUSTED);
    test("HTMLListItemElement.value=.", ({ li }) => li.value=UNTRUSTED);
    test("HTMLMapElement.name=.", ({ map }) => map.name=UNTRUSTED);
    test("HTMLMenuElement.type=.", ({ menu }) => menu.type=UNTRUSTED);
    test("HTMLMetaElement.name=.", ({ meta }) => meta.name=UNTRUSTED);
    test("HTMLMeterElement.value=.", ({ meter }) => meter.value=3.14);
    test("HTMLObjectElement.codebase=.", ({ object }) => object.codebase=UNTRUSTED);
    test("HTMLObjectElement.data=.", ({ object }) => object.data=UNTRUSTED);
    test("HTMLObjectElement.name=.", ({ object }) => object.name=UNTRUSTED);
    test("HTMLObjectElement.type=.", ({ object }) => object.type=UNTRUSTED);
    test("HTMLOListElement.type=.", ({ ol }) => ol.type=UNTRUSTED);
    test("HTMLOptionElement.value=.", ({ option }) => option.value=UNTRUSTED);
    test("HTMLOutputElement.name=.", ({ output }) => output.name=UNTRUSTED);
    test("HTMLParamElement.value=.", ({ param }) => param.value=UNTRUSTED);
    test("HTMLParamElement.name=.", ({ param }) => param.name=UNTRUSTED);
    test("HTMLProgressElement.value=.", ({ progress }) => progress.value=3.14);
    test("HTMLScriptElement.innerHTML=.", ({ script }) => script.innerHTML=UNTRUSTED);
    test("HTMLScriptElement.innerText=.", ({ script }) => script.innerText=UNTRUSTED);
    test("HTMLScriptElement.src=.", ({ script }) => script.src=UNTRUSTED);
    test("HTMLScriptElement.text=.", ({ script }) => script.text=UNTRUSTED);
    test("HTMLScriptElement.type=.", ({ script }) => script.type=UNTRUSTED);
    test("HTMLScriptElement.textContent=.", ({ script }) => script.textContent=UNTRUSTED);
    test("HTMLSelectElement.name=.", ({ select }) => select.name=UNTRUSTED);
    test("HTMLSourceElement.type=.", ({ source }) => source.type=UNTRUSTED);
    test("HTMLStyleElement.type=.", ({ style }) => style.type=UNTRUSTED);
    test("HTMLTextAreaElement.name=.", ({ textarea }) => textarea.name=UNTRUSTED);
    test("JSON.parse(., _)", () => JSON.parse(`["${UNTRUSTED}"]`));
    test("localStorage.setItem(., _)", () => localStorage.setItem(UNTRUSTED, placeholder));
    test("localStorage.setItem(_, .)", () => localStorage.setItem(placeholder, UNTRUSTED));
    // test("Location.assign(.)", () => location.assign(untrusted));
    test("Location.hash=.", () => location.hash=UNTRUSTED);
    // test("Location.host=.", () => location.host=untrusted);
    // test("Location.hostname=.", () => location.hostname=untrusted);
    // test("Location.href=.", () => location.href=untrusted);
    // test("Location.href=.", () => location.href=`javascript:${untrusted}`);
    // test("Location.pathname=.", () => location.pathname=untrusted);
    test("Location.port=.", () => location.port=UNTRUSTED);
    test("Location.protocol=.", () => location.protocol=UNTRUSTED);
    // test("Location.replace(.)", () => location.replace(untrusted));
    // test("Location.replace(.)", () => location.replace(`javascript:${untrusted}`));
    test("Location.search=.", () => location.search=UNTRUSTED);
    // test("msSetImmediate(., ...)", () => msSetImmediate(untrusted));
    test("Node.appendChild(.)", ({ el }) => el.appendChild(UNTRUSTED));
    test("Node.replaceChild(., _)", ({ el }) => el.appendChild(UNTRUSTED, trusted));
    test("Node.textContent=.", ({ el }) => el.textContent=UNTRUSTED);
    test("Range.createContextualFragment(.)", () => document.createRange().createContextualFragment(UNTRUSTED));
    test("new RegExp(., _)", () => new RegExp(UNTRUSTED));
    test("new RegExp(_, .)", () => new RegExp(/trusted/, "g"));
    test("requestFileSystem(., _, _, _)", () => webkitRequestFileSystem(UNTRUSTED, 1, () => {}));
    test("sessionStorage.setItem(., _)", () => sessionStorage.setItem(UNTRUSTED, placeholder));
    test("sessionStorage.setItem(_, .)", () => sessionStorage.setItem(placeholder, UNTRUSTED));
    // test("setImmediate(., ...)", () => setImmediate(untrusted));
    test("setInterval(., ...)", () => setInterval(UNTRUSTED));
    test("setTimeout(., ...)", () => setTimeout(UNTRUSTED));
    test("new WebSocket(., _)", () => new WebSocket(`ws://${UNTRUSTED}`));
    test("new WebSocket(., _)", () => new Promise((resolve, reject) => { const ws = new WebSocket("https://echo.websocket.org/"); ws.onopen = () => { try { ws.send(UNTRUSTED); resolve() } catch(error) { reject(error) } } }));
    // test("window.location=.", () => window.location=untrusted);
    test("window.open(.)", () => window.open(UNTRUSTED));
    test("window.postMessage(., _, _)", () => window.postMessage(UNTRUSTED));
    test("window.postMessage(_, ., _)", () => window.postMessage(placeholder, "https://example.com/"));
    test("new XMLHttpRequest().open(., _, _, _, _)", () => (new XMLHttpRequest()).open(UNTRUSTED, placeholder));
    test("new XMLHttpRequest().open(_, ., _, _, _)", () => (new XMLHttpRequest()).open(placeholder, UNTRUSTED));
    test("new XMLHttpRequest().send(.)", () => { const req = new XMLHttpRequest(); req.open("GET", "/"); req.send(UNTRUSTED); });
    test("new XMLHttpRequest().setRequestHeader(., _)", () => { const req = new XMLHttpRequest(); req.open("GET", "/"); req.setRequestHeader(UNTRUSTED, placeholder); });
    test("new XMLHttpRequest().setRequestHeader(_, .)", () => { const req = new XMLHttpRequest(); req.open("GET", "/"); req.setRequestHeader(placeholder, UNTRUSTED); });
    test("Navigator.sendBeacon(., _)", () => navigator.sendBeacon(`http://${UNTRUSTED}`));
    test("Navigator.sendBeacon(_, )", () => navigator.sendBeacon("https://example.com/", UNTRUSTED));
  } else {
    document.getElementById("no-trusted-types").hidden = false;
  }
  </script>

  <hr>

  <div>
    <p>
      The software is available under the
      <a
        href="./LICENSE"
      >MPL-2.0 license</a>.
    </p>
  </div>
</body>

</html>
